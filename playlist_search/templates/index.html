{% extends "base.html" %}
{% block content %}
<form action="#" id="spotify_url_form" onsubmit="submitNewBetEventForm();return false">
Spotify song URL: <input type="text" id="spotify_url_textbox"></input>
<input type="submit">
</form>
<p>
<span id="rawResults"></span>
<div id="results">
<span id="errorLabel"></span><br /><br />
Name: <span id="songName"></span><br />
Artist: <span id="songArtists"></span><br />
Album: <span id="songAlbum"></span><br /><br />
Playlists:<br />
<ul id="playlistList">
</ul>
</div>
</p>
<script>

function removeTrailingSlashIfExists(url) {
    var lastSlash = url.lastIndexOf("/");
    if (lastSlash == url.length - 1) {
        url = url.substr(0, url.length - 1);
    }
    return url
}

function getSpotifyIdFromUrl(urlInput) {
    var urlCopy = (' ' + urlInput).slice(1); // https://stackoverflow.com/a/31733628/3846218

    urlCopy = removeTrailingSlashIfExists(urlCopy);

    var lastSlash = urlCopy.lastIndexOf("/");

    var idStart = lastSlash + 1;
    var idLength = urlCopy.length - idStart;

    spotifyId = urlCopy.substr(idStart, idLength);

    return spotifyId;
}

function getSpotifyTypeFromUrl(urlInput) {
    var urlCopy = (' ' + urlInput).slice(1); // https://stackoverflow.com/a/31733628/3846218

    urlCopy = removeTrailingSlashIfExists(urlCopy);

    var lastSlash = urlCopy.lastIndexOf("/");
    var secondToLastSlash = urlCopy.lastIndexOf("/", lastSlash - 1);

    var typeStart = secondToLastSlash + 1;
    var typeLength = lastSlash - typeStart;

    var spotifyType = urlCopy.substr(typeStart, typeLength);

    return spotifyType
}

function submitNewBetEventForm() {
    var spotifyUrl = $("#spotify_url_textbox").val();
    var spotifyId = getSpotifyIdFromUrl(spotifyUrl);
    var spotifyType = getSpotifyTypeFromUrl(spotifyUrl);
    console.log('spotifyId = ' + spotifyId)
    console.log('spotifyType = ' + spotifyType)

    if (spotifyType == 'track') {
        $.get("/track/?spotify_id="+spotifyId, {},
            function(track) {
                $('#errorLabel').text('');
                $('#playlistList').text('');
                $('#songName').text('');
                $('#songArtists').text('');
                $('#songAlbum').text('');

                if ($.isEmptyObject(track)) {
                    $('#errorLabel').text('Error: Track not found in database (does not exist in any playlists)');
                    return;
                }

                $('#songName').text(track.name);
                var artistNames = $.map(track.artists, function(artist) { return artist["name"] });
                $('#songArtists').text(artistNames.join(', '))
                $('#songAlbum').text(track.album["name"]);

                $.each(track.playlists, function(index, playlist) {
                    console.log(playlist);
                    var playlistUrl = playlist.external_urls["spotify"];
                    var trackRankInPlaylist = playlist.track_rank
                    var trackAddedAt = playlist.added_at
                    var playlistLink = "<a href=\"" + playlistUrl + "\">" + playlist.name + "</a>";
                    var internalList = '<ul><li>Current position: ' + trackRankInPlaylist + '</li><li>Added at: ' + trackAddedAt + '</li></ul>'
                    $('#playlistList').append($('<li>', {
                        html: playlistLink
                    })).append(internalList);
                });

                console.log(track);
            });
    } else if (spotifyType == "album") {
        $.get("/album/?spotify_id="+spotifyId, {},
            function(album) {
                $('#errorLabel').text('');
                $('#playlistList').text('');
                $('#songName').text('');
                $('#songArtists').text('');
                $('#songAlbum').text('');

                if ($.isEmptyObject(album)) {
                    $('#errorLabel').text('Error: Album not found in database (none of its tracks are in the playlists we stored)');
                    return;
                }


                //$('#songName').text(album.name);
                var artistNames = $.map(album.artists, function(artist) { return artist["name"] });
                $('#songArtists').text(artistNames.join(", "))
                $('#songAlbum').text(album["name"]);

                //$.each(album.playlists, function(index, element) {
                //    $('#playlistList').append($('<li>', {
                //        text: element.name
                //    }));
                //});

                console.log(album);
        });
    }
}
</script>
{% endblock %}
